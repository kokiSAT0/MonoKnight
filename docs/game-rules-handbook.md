# MonoKnight ゲームルールハンドブック

<!-- ドキュメント全体の役割と更新方針を明示して、参照者の期待値をそろえる -->
本書は MonoKnight に実装されているゲームルールの決定版ハンドブックとして、ゲームプロデュースチームや新規メンバーが仕様を把握し、
バランス調整やキャンペーン設計の議論へ即座に参加できる状態を作ることを目的とする。実装の一次情報は `Game` Swift Package 配下の
コードであり、仕様変更時は必ず本書を併走更新する。<!-- コードとドキュメントの差分放置を防ぐ -->

## 1. 盤面・座標・初期配置

<!-- 座標系と初期化ロジックの要点をまとめて、開発者が盤面改修時に参照できるようにする -->
- 盤面は `BoardGeometry` が提供する **N×N グリッド**。スタンダードモードおよびキャンペーン現行ステージは **5×5** を採用する。
- 座標系は **左下が原点 `(0,0)`**。右方向が `+x`、上方向が `+y`。UI 表示では下段が y=0。<!-- 盤面テスト時の取り違え防止 -->
- 初期スポーンは `GameMode.SpawnRule.fixed` で管理し、標準仕様では常に中央マス (`BoardGeometry.defaultSpawnPoint`) へ配置する。
- 初期踏破状態はスポーンマス 1 枚のみが `visited`。スポーン選択型モード (`chooseAnyAfterPreview`) では初期踏破マスは無し。<!-- クリア判定の初期条件を明確化 -->

## 2. 手札・山札の基本仕様

### 2-1. 手札スロットと表示

- `GameMode.Regulation.handSize` で保持できるカード**種類**の上限を定義。標準・キャンペーン共に **5 種類**。
- `nextPreviewCount` は常時公開される先読み枚数。標準構成では **3 枚**。<!-- UI 表示と一致させる -->
- `allowsStacking` が `true` のため、同じカードは 1 スロット内でスタックされる。スタック上限は実装上無制限。<!-- 枠数を超える事故を防ぐ -->

### 2-2. 山札プリセットと重み

- 山札は `Deck` が担当し、`GameDeckPreset` 経由で構成を切り替える。スタンダードは `GameDeckPreset.standard` を使用。
- 抽選は **重み付き乱数**。標準系プリセットではすべてのカードを同一重み（1）で扱い、個別調整が必要な場合は `WeightProfile` の `overrides` でカード単位の重みを変更する。<!-- RNG バランスの中核 -->
- 連続排出抑制などの追加処理は行わず、重みテーブルのみで結果が決定する。<!-- 抽選の再現性と説明責任を確保 -->
- その他プリセットも `Deck.Configuration` として実装済み。キャンペーンや練習用に `kingOnly`、`standardWithOrthogonalChoices` などを利用する。

### 2-3. 標準デッキ構成

- `MoveCard.standardSet` には **24 種類**の単方向カードを収録。
  - **キング型**（周囲 1 マス移動）8 種。
  - **ナイト型**（±1/±2 ジャンプ）8 種。
  - **直線距離 2**（上下左右）4 種。
  - **斜め距離 2**（4 方向）4 種。
- キャンペーンでは追加で **選択式カード**（上下左右・斜め・桂馬の 4 系統 × 各 2〜4 方向）10 種を使用。これらは `MoveCard.allCases` で標準セットに連結され、プリセット単位で採用可否を制御する。<!-- 新カード追加時の参照先 -->

### 2-4. カード使用手順と複数候補

- `GameCore.availableMoves()` が現在位置と盤面状況から合法手を算出し、UI で使用可能カードのみ選択肢として提示する。
- 1 枚のカードが複数ベクトルを持つ場合（選択式カード）は、`playCard(at:selecting:)` に `MoveVector` を渡すことで方向を確定させる。未指定時は候補が 1 つだけのとき自動決定。<!-- 選択 UI 実装時の仕様確認 -->
- 盤外・障害物・トグルで未踏条件を満たせないマスは候補から除外され、UI 上ではグレーアウト表示。<!-- 利用者へのフィードバック整理 -->

## 3. ペナルティと補助操作

<!-- ペナルティ系統の種類と発動条件を整理して、バランス調整時の変更漏れを防ぐ -->
- ペナルティ設定は `GameMode.PenaltySettings` が保持。種類は次の 4 系統。
  1. **手詰まり (deadlock)**: 全カードが使用不能になった際に自動発動。標準モードでは **+5 手**。発生ログを残し、手札・先読みを全更新。
  2. **手動引き直し (manualRedraw)**: ユーザーがリロードボタンを押すと発動。標準では **+5 手**。直後に再び手詰まりなら追加ペナルティなしで再抽選。
  3. **捨て札 (manualDiscard)**: ゴミ箱アイコンでスタックを 1 種類まとめて破棄。標準では **+1 手**。VoiceOver への案内を含め UI 側でモード開始/終了を制御。
  4. **再訪 (revisit)**: 既踏マスへ戻った際に加算。スタンダードと多くのキャンペーンでは **0**。クラシカル系では **+1**。<!-- ルール差異を明確化 -->
- ペナルティ発生時は `GameCore+Penalty` が共通処理を実行し、`penaltyEventID` を更新して UI へ通知する。<!-- 実装追跡ポイント -->

### 3-1. 代表的なペナルティ設定例

| シナリオ | deadlock | manualRedraw | manualDiscard | revisit | 備考 |
|----------|----------|--------------|---------------|---------|------|
| スタンダード (`GameMode.standard`) | +5 | +5 | +1 | 0 | リーダーボード対象。 |
| クラシカルチャレンジ (`GameMode.classicalChallenge`) | +2 | +2 | +1 | +1 | 8×8 盤・桂馬のみ。 |
| キャンペーン 1-1 「王将訓練」 | +2 | +2 | +1 | +1 | クラシカル設定を継承。 |
| キャンペーン 1-2 / 2-1 | +3 | +1 | +1 | 0 | 中盤導入向け緩和設定。 |
| キャンペーン 3 章以降 | +5 | +5 | +1 | 0 | スタンダードに準拠。 |

<!-- 将来の調整時は上表を増補し、コード変更と同時に更新する -->

## 4. 盤面ギミックとタイル種別

<!-- 盤面ギミックの優先順位や併用制約を明示し、デザイナーと実装者の齟齬を防ぐ -->
- **通常マス**: 踏むと `visited = true`。再訪ペナルティ設定が有効な場合のみ追加手数。
- **追加踏破マス** (`additionalVisitRequirements`): 指定カウント踏むまで未踏扱い。キャンペーン 2-1 では `(0,1)`・`(2,3)` が 2 回必要。<!-- 1 始まり共有座標の変換に注意 -->
- **トグルマス** (`toggleTilePoints`): 踏むたびに踏破状態を反転。キャンペーン 4-1 で `(0,1)`・`(2,3)` に配置。追加踏破設定よりトグルが優先。
- **障害物マス** (`impassableTilePoints`): 完全通行不可。手札候補にも表示されず、経路の自由度を制限。キャンペーン 5-1 で導入。
- **スポーンマス**: `Board` 初期化時に自動で踏破済み扱い。スポーン選択モードの場合は踏破済みマスが存在しない点に注意。<!-- クリア条件の判定漏れ防止 -->

## 5. クリア条件とスコアリング

<!-- スコア計算やクリア判定の仕様を共有し、ランキング連携時の確認事項を整理 -->
- 盤面の **全マスが踏破済み**（トグルの場合は踏破側で停止している状態）になるとクリア。`GameCore` は `remainingTiles == 0` で `progress = .cleared` へ遷移。
- クリアまでの統計値 `CampaignStageClearMetrics` / `GameCore` プロパティとして以下を保持。
  - `moveCount`: 実際に移動した回数。
  - `penaltyCount`: ペナルティによる加算手数。
  - `elapsedSeconds`: `GameSessionTimer` が計測した経過時間（1 秒単位）。
  - `hasRevisitedTile`: 既踏マスへ戻った履歴。
- **スコア公式**は `score = (moveCount + penaltyCount) × 10 + elapsedSeconds`。小さいほど好成績。Game Center 送信対象はリーダーボード対応モードのみ。
- キャンペーンではスター条件として **セカンダリ目標**（手数・時間・ペナルティ）と **スコア上限**（≦ または ＜）を組み合わせる。比較方式は `CampaignStage.ScoreTargetComparison` で管理。<!-- レギュレーションとスター判定の連携を明確化 -->

## 6. 実装参照マップと更新手順

<!-- ドキュメントとコードの紐付けを明確化し、更新漏れを防ぐ -->
- ルール全般の実装: `Game/GameCore.swift`・`Game/GameCore+Penalty.swift`。
- カード定義と山札: `Game/MoveCard.swift`・`Game/Deck.swift`。
- モードとレギュレーション: `Game/GameMode.swift`（`Regulation`・`PenaltySettings`）。
- キャンペーン固有設定: `Game/CampaignStage.swift`。詳細なステージ規定は [`docs/campaign-stage-regulations.md`](campaign-stage-regulations.md) を参照。<!-- 相互参照を整備 -->
- 更新フロー: コード変更 → 単体テスト更新 → 本書・キャンペーンドキュメント改訂 → PR 作成。<!-- 運用サイクルを明文化 -->

