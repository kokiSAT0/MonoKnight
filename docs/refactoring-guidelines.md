# 継続的な開発に向けたリファクタリング基本方針

本ドキュメントは、MonoKnight を継続的に改良・運用していくうえで優先すべきリファクタリングの考え方と進め方を整理したものです。現状の実装を大きく崩さずに改善を積み重ね、App Store 提出レベルの品質を保ちながら開発速度を落とさないことを目的とします。

## 1. 目標と前提
- **品質の安定化**: App Store 審査を想定し、致命的バグや UI 崩れを防止する。
- **負債の可視化と段階的解消**: 大規模改修ではなく、小さな単位で負債を洗い出し順次解消する。
- **作業サイクルの最適化**: Windows + VSCode + codex での開発と、macOS + Xcode での検証を円滑に繋ぐ。

## 2. リファクタリング全体方針
- **Swift Package を中核に据える**: `Game` ディレクトリ配下は Swift Package として機能分割済みのため、パッケージ境界を尊重しつつ、ロジックと UI の依存関係を明確に保つ。
- **責務の単純化**: ObservableObject やサービス層が肥大化しないよう、役割ごとにファイルを整理し、1 ファイル 1 責務を意識する。
- **テスト容易性の確保**: SPM テストで検証できる純粋ロジックを増やす。副作用を伴う処理はプロトコル抽象化で差し替え可能にする。
- **ドキュメント整備**: リファクタリングで決めたルールは `docs/` に記録し、将来の変更時に参照できる状態を保つ。
- **共通サポートモジュールの活用**: 共有ターゲット `SharedSupport` が導入されたため、`debugLog` や `CrashFeedbackCollector`
  を活用しつつ、各層のログ・計測を統一化する。

### 2.1 直近の改善サマリ
- **Game モジュールの公開インターフェース整理**: `GameModuleInterfaces` を経由して `GameCore`
  を生成する流れが定着し、UI 側からの依存が一本化された。
- **UI 層の三層分割が完了**: `GameView` 本体から描画以外の責務を切り出し、`GameViewModel` と `GameBoardBridgeViewModel`
  が状態管理・SpriteKit 連携を引き受ける構成に刷新された。レイアウト計算は `GameViewLayoutCalculator` へ集約され、
  `GameViewLayoutCalculatorTests` によるユニットテストも追加済み。
- **レイアウト診断の可視化**: `BoardLayoutSnapshot` と詳細ログを追加し、盤面サイズのフォールバックやセーフエリア補正の挙動を
  `debugLog` から追跡できるようになった。今後はこのログを活用した開発者ツール整備が必要。
- **SharedSupport モジュールの整備**: `DebugLogHistory` と `CrashFeedbackCollector` により、TestFlight などでも
  開発者向けログ・フィードバック履歴を共有できる下地が整った。サービス層や UI からの再利用方針を明文化しておく。
- **GameMode ペナルティ検証テストを追加**: `Tests/GameTests/GameModePenaltyTests` でペナルティ設定の反映を網羅し、盤サイズ拡張や
  キャンペーン専用ルールを導入する際の回帰検知を強化した。
- **ATT 許諾変化に対応したモックシナリオ**: `MonoKnightAppTests/AdsConsentCoordinatorTests` に ATT の許諾状態が途中で変わるケースを
  追加し、同意再取得時に NPA フラグと広告再ロードが確実に更新されることを保証した。
- **GameCore のタイマー責務分離**: ゲーム内の経過時間管理を `GameSessionTimer` へ委譲し、`GameCore` 本体の責務を
  シンプルに保つ取り組みを開始した。経過秒数の算出やテスト用ヘルパーを専用構造体へ集約することで、将来的な
  計測仕様変更や複数モード対応時の再利用性が高まる。
- **カード移動候補の解決処理を共通化**: 盤面内へ進めるカード判定を `GameCore.availableMoves()` と `ResolvedCardMove`
  へ集約し、UI・ペナルティ判定・テストで同一ロジックを再利用できるよう整理した。`GameBoardBridgeViewModel`
  からのガイド表示やアニメーション、手詰まり検出まで同じ候補列を参照するため、座標重複や境界判定の重複実装
  を防げる構成になっている。
- **診断ログビューアの導線追加**: `SettingsView` に `DiagnosticsCenterView` を組み込み、`DebugLogHistory` / `CrashFeedbackCollector`
  の内容をアプリ内で直接閲覧・削除できるようにした。公開ビルドでは環境変数でメニューを無効化できるため、ユーザー向け配信時も安全に利用できる。

### 2.2 診断ログ運用メモ
- `MonoKnightApp` の初期化で `DebugLogHistory.shared.setFrontEndViewerEnabled` を制御している。
  - DEBUG ビルドでは常に `true` にして開発時の検証を容易にする。
  - リリースビルドでは環境変数 `ENABLE_DIAGNOSTICS_MENU=1` を指定したときのみ有効化されるため、TestFlight 用と App Store 用で挙動を切り替えられる。
- 設定画面の「開発者向け診断」セクションから `DiagnosticsCenterView` を開くと、以下の操作が行える。
  - デバッグログの履歴閲覧・全文コピー・全削除。
  - クラッシュ／フィードバック履歴の閲覧と削除。
  - フロントエンド向けログ履歴の保持オン/オフ切り替え（無効にすると履歴もクリアされる）。
- ログ閲覧が不要なビルドでは `DebugLogHistory.shared.setFrontEndViewerEnabled(false)` を呼び出せば履歴がクリアされ、設定画面からもメニューが消える。

## 3. 優先すべきリファクタリング領域
1. **ゲームコアロジック (`Game` パッケージ)**
   - `GameModuleInterfaces` を経由した依存注入が整備されたため、今後は `HandManager` や `Deck` の再利用性を高める。
   - モードごとのペナルティ・手札整理ロジックを `GameMode` のパラメータに一本化し、盤面追加時にも破綻しないようテストを拡充する。
     `GameCore+Penalty.swift` など機能別ファイルの役割をドキュメントへ反映しておく。
2. **UI レイヤー (`UI/` ディレクトリ)**
   - `GameViewModel` / `GameBoardBridgeViewModel` / `GameViewLayoutCalculator` による三層構造を維持しつつ、Combine 購読や
     `DispatchWorkItem` の破棄漏れが起こらないようユニットテスト・統合テストを整える。
   - `BoardLayoutSnapshot` で収集したログの閲覧導線を準備し、iPad 向け余白やアクセシビリティ調整を継続的に検証する。
   - `ResultView`・`SettingsView`・`ConsentFlowView` など周辺画面の共通スタイル化と、開発者向け診断項目の導線整理を進める。
3. **サービス層 (`Services/` ディレクトリ)**
   - StoreKit・Game Center・AdMob 各サービスはプロトコル化済みなので、`SharedSupport` のログ仕組みを活かした障害検知とリトライ戦略
     の明文化が次の焦点。
   - ユーザー同意フロー（ATT/UMP）の状態遷移はドキュメント化済み。今後は `AdsConsentCoordinator` のモックシナリオを追加し、自動テストで
     同意状態を網羅できるようにする。
4. **共通基盤 (`SharedSupport/` ディレクトリ)**
   - `DebugLogHistory` と `CrashFeedbackCollector` の利用ポリシーをまとめ、アプリ本体からの参照方法（設定画面・開発者メニュー）を具体化
     する。ログ閲覧機能やレビュー履歴の UI を追加する際は、このモジュールを経由して一元管理する。

## 4. 実施プロセス
1. **現状把握**
   - `docs/recommended-task-list.md` を参照し、未着手または負債化している項目を棚卸しする。
   - 主要ファイルの責務と依存関係を可視化し、優先度と影響範囲を評価する。
2. **小さな単位での改善**
   - 単一責務の関数・型抽出、命名改善、コメント整備など低リスクの変更から着手。
   - テストがない領域はテスト追加を優先し、テストがある領域は既存テストを壊さないようリファクタリング。
   - `BoardLayoutSnapshot` のログや `DebugLogHistory` の履歴を確認し、挙動が不安定な箇所を可視化してからコードへ着手する。
3. **レビューとドキュメント更新**
   - 変更内容は PR ごとに目的と効果を明記し、`docs/` 配下のガイドライン更新をセットで行う。
   - 影響範囲が広い変更は、段階的 PR（機能追加→内部改善）に分割する。
   - `GameViewLayoutCalculatorTests` など新設・更新したテストケースの意図を PR で共有し、再現手順とログ採取方法を備考に残す。
4. **継続的な振り返り**
   - リファクタリング後にクラッシュログやユーザーフィードバックを確認し、追加の負債が発生していないかチェックする。
   - 開発の節目でリファクタリング計画を見直し、優先順位の入れ替えや完了済み項目のアーカイブを行う。

## 5. 実務上のチェックリスト
- [ ] 変更対象の責務と依存を事前に整理し、PR 説明に記載したか。
- [ ] Swift Package Manager のテストが成功するか（`swift test`）。
- [ ] 主要画面（GameView/ResultView/SettingsView）で UI 崩れがないか実機またはシミュレーターで確認したか。
- [ ] StoreKit/AdMob/Game Center のモック実装を用意し、ネットワーク依存を減らしているか。
- [ ] リファクタリングの成果と次の課題を `docs/` に記録したか。
- [ ] `BoardLayoutSnapshot` のログを確認し、セーフエリアや盤面サイズのフォールバックが意図通りか検証したか。

### 5.1 手動確認メモ（ハイライト挙動）
- 2024-05-09: `GameScene.updateHighlights` リファクタリング後に以下の手動確認を実施。
  - ガイド設定 ON で手札を更新し、`.guide` キー経由のハイライトが従来通り点灯することを確認。
  - ガイド設定 OFF の状態で `GameViewModel.updateForcedSelectionHighlight(for:)` を介して強制候補を送信し、`.forcedSelection` が単独で表示されることを確認。
  - カードプレイ完了時に強制ハイライトが自動解除されることを確認し、次ターンへ残像が残らないことを検証。

## 6. 今後の展開に向けた留意点
- **可変盤サイズや追加モード**を視野に入れ、ゲームロジックを盤サイズ依存の定数から切り離す。
- **アクセシビリティや多言語対応**の拡張を想定し、文字列・ラベル管理を一元化する。
- **モジュール分割**が必要になった場合でも、既存の Swift Package 構成を基盤とし、依存方向は `Game` → `Services` → `UI` のように一方向を維持する。
- **SharedSupport の拡張**: 開発者向けのログビューアやクラッシュレビュー UI を実装する際は `SharedSupport` を中心に据え、アプリ本体・ウィジェットなど複数ターゲットで再利用できる形へ育てる。

---

上記方針に沿って段階的に改善を進めることで、MonoKnight の開発を継続的に進めつつ品質向上と新機能追加の双方をバランス良く達成していきます。最新のログ・テスト基盤を活用しながら改善サイクルを回し、App Store 提出に耐える堅牢な構成を維持していきましょう。
