# 継続的な開発に向けたリファクタリング基本方針

本ドキュメントは、MonoKnight を継続的に改良・運用していくうえで優先すべきリファクタリングの考え方と進め方を整理したものです。現状の実装を大きく崩さずに改善を積み重ね、App Store 提出レベルの品質を保ちながら開発速度を落とさないことを目的とします。

## 1. 目標と前提
- **品質の安定化**: App Store 審査を想定し、致命的バグや UI 崩れを防止する。
- **負債の可視化と段階的解消**: 大規模改修ではなく、小さな単位で負債を洗い出し順次解消する。
- **作業サイクルの最適化**: Windows + VSCode + codex での開発と、macOS + Xcode での検証を円滑に繋ぐ。

## 2. リファクタリング全体方針
- **Swift Package を中核に据える**: `Game` ディレクトリ配下は Swift Package として機能分割済みのため、パッケージ境界を尊重しつつ、ロジックと UI の依存関係を明確に保つ。
- **責務の単純化**: ObservableObject やサービス層が肥大化しないよう、役割ごとにファイルを整理し、1 ファイル 1 責務を意識する。
- **テスト容易性の確保**: SPM テストで検証できる純粋ロジックを増やす。副作用を伴う処理はプロトコル抽象化で差し替え可能にする。
- **ドキュメント整備**: リファクタリングで決めたルールは `docs/` に記録し、将来の変更時に参照できる状態を保つ。

## 3. 優先すべきリファクタリング領域
1. **ゲームコアロジック (`Game` パッケージ)**
   - モデル・カード定義・山札・ゲーム進行の依存関係を棚卸しし、テスト容易性と再利用性を高める。
   - パブリック API の命名やアクセシビリティ制御を見直し、UI 側からの利用方法を統一する。
2. **UI レイヤー (`UI/` ディレクトリ)**
   - SwiftUI と SpriteKit の橋渡し部分で状態管理が複雑化しないよう、ViewModel 的な仲介層を用意することを検討。
   - `ResultView` や `SettingsView` など、設定・スコア関連画面のレイアウト共通化を進め、iPad 対応を見据える。
3. **サービス層 (`Services/` ディレクトリ)**
   - StoreKit・Game Center・AdMob など非同期 API を扱うコードに対し、テスト可能な抽象化とエラーハンドリングを整理する。
   - ユーザー同意フロー（ATT/UMP）の状態遷移を明文化し、将来の規制変更に対応しやすくする。

## 4. 実施プロセス
1. **現状把握**
   - `docs/recommended-task-list.md` を参照し、未着手または負債化している項目を棚卸しする。
   - 主要ファイルの責務と依存関係を可視化し、優先度と影響範囲を評価する。
2. **小さな単位での改善**
   - 単一責務の関数・型抽出、命名改善、コメント整備など低リスクの変更から着手。
   - テストがない領域はテスト追加を優先し、テストがある領域は既存テストを壊さないようリファクタリング。
3. **レビューとドキュメント更新**
   - 変更内容は PR ごとに目的と効果を明記し、`docs/` 配下のガイドライン更新をセットで行う。
   - 影響範囲が広い変更は、段階的 PR（機能追加→内部改善）に分割する。
4. **継続的な振り返り**
   - リファクタリング後にクラッシュログやユーザーフィードバックを確認し、追加の負債が発生していないかチェックする。
   - 開発の節目でリファクタリング計画を見直し、優先順位の入れ替えや完了済み項目のアーカイブを行う。

## 5. 実務上のチェックリスト
- [ ] 変更対象の責務と依存を事前に整理し、PR 説明に記載したか。
- [ ] Swift Package Manager のテストが成功するか（`swift test`）。
- [ ] 主要画面（GameView/ResultView/SettingsView）で UI 崩れがないか実機またはシミュレーターで確認したか。
- [ ] StoreKit/AdMob/Game Center のモック実装を用意し、ネットワーク依存を減らしているか。
- [ ] リファクタリングの成果と次の課題を `docs/` に記録したか。

## 6. 今後の展開に向けた留意点
- **可変盤サイズや追加モード**を視野に入れ、ゲームロジックを盤サイズ依存の定数から切り離す。
- **アクセシビリティや多言語対応**の拡張を想定し、文字列・ラベル管理を一元化する。
- **モジュール分割**が必要になった場合でも、既存の Swift Package 構成を基盤とし、依存方向は `Game` → `Services` → `UI` のように一方向を維持する。

---

上記方針に沿って段階的に改善を進めることで、MonoKnight の開発を継続的に進めつつ品質向上と新機能追加の双方をバランス良く達成していきます。
