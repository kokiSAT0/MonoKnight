# キャンペーンモード移行前のリファクタリング指針

## 概要
- キャンペーンモード実装に着手する前に、UI ビューモデルの安定化、ログ診断導線の拡充、SharedSupport のログ管理 UI 整備を優先的に実施する。
- Game パッケージと UI 層の責務分離、ログ基盤活用、将来モード拡張に備えたテスト体制を柱に段階的リファクタリングを進める。
- 推奨タスクは「テスト整備」「ログ閲覧導線」「運用ガイドライン」の三本柱で整理し、キャンペーンモード向け仕様検証へ滑らかに移行するためのロードマップとする。

## 短期（スプリント 1〜2）で完了させるタスク
1. **`GameViewModel` / `GameBoardBridgeViewModel` の統合テスト追加**
   - Combine 購読、`DispatchWorkItem` のキャンセル、SpriteKit 連携を自動検証するテストケースを整備し、ビューモデル三層構造の安定性を確保する。
   - テスト作成と並行して `swift test` 実行を PR チェックリストへ組み込み、回帰検知を高速化する。
2. **`BoardLayoutSnapshot` ログ閲覧導線の設定画面統合**
   - `DebugLogHistory` へスナップショットを集約し、iPad レイアウト調整やアクセシビリティ検証に迅速にアクセスできる開発者メニューを用意する。
   - ログ閲覧とクリア操作の UI/UX を SharedSupport の方針に合わせて整理し、公開ビルドで無効化できるガードを導入する。
3. **SharedSupport ログ管理画面の整備**
   - `DebugLogHistory` と `CrashFeedbackCollector` を操作できる設定画面モジュールを構築し、TestFlight 運用での診断作業を効率化する。
   - 運用ガイドラインを `docs/` 配下に追記し、リリースビルドでの無効化手順を明文化する。

## 中期（スプリント 3 以降）で着手するタスク
1. **ゲームモード拡張を見据えたパラメータ整理**
   - `GameMode` のペナルティや手札ロジックをドキュメントとテストで再確認し、キャンペーン専用ルール追加時の破綻を防ぐ。
   - `GameSessionTimer` など責務分離済みコンポーネントの再利用指針をまとめ、モードごとの調整が可能な設計へ寄せる。
2. **サービス層のモックシナリオ拡充**
   - ATT/UMP 同意フローと広告頻度の UX 検証を自動テストに取り込み、キャンペーンモードでの広告タイミング検証を容易にする。
3. **開発者向けドキュメント強化**
   - リファクタリング成果、ログ活用手順、テスト実行フローを `docs/refactoring-guidelines.md` などの関連ガイドへ追記し、次フェーズ移行時の参照性を高める。

## キャンペーンモード移行前の完了条件
- 上記短期タスクが完了し、UI・ゲームコア・サービス層の回帰テストとログ診断導線が整備されていること。
- `docs/recommended-task-list.md` の該当項目（統合テスト・ログ導線・ログポリシー）が「完了」に更新され、運用チームが新モード実装後の QA フローを共有できる状態になっていること。
- SharedSupport 経由のログ監視とクラッシュ収集が TestFlight 運用で実証され、キャンペーンモードで追加されるシナリオにも再利用可能であること。

## 次のアクション
- 本ドキュメントを Sprint プランニングの基準とし、進捗はスプリントレビュー時に更新する。
- タスク完了後はキャンペーンモードの仕様定義とプロトタイプ作成に着手する。
