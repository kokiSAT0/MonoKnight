# キャンペーンモード移行前のリファクタリング指針

## 概要
- キャンペーンモード実装に着手する前に、UI ビューモデルの安定化、ログ診断導線の拡充、SharedSupport のログ管理 UI 整備を優先的に実施する。
- Game パッケージと UI 層の責務分離、ログ基盤活用、将来モード拡張に備えたテスト体制を柱に段階的リファクタリングを進める。
- 推奨タスクは「テスト整備」「ログ閲覧導線」「運用ガイドライン」の三本柱で整理し、キャンペーンモード向け仕様検証へ滑らかに移行するためのロードマップとする。

## 短期（スプリント 1〜2）で完了させるタスク
- [x] **`GameViewModel` / `GameBoardBridgeViewModel` の統合テスト追加**
  - Combine 購読、`DispatchWorkItem` のキャンセル、SpriteKit 連携を自動検証するテストケースを `MonoKnightAppTests/GameViewIntegrationTests.swift` に追加し、ビューモデル三層構造の安定性を確認できるようにした。
  - `PenaltyBannerScheduler` をプロトコル化して差し替え可能にし、将来的に `swift test` を CI へ組み込む際の前提条件を整備済み。
- [x] **`BoardLayoutSnapshot` ログ閲覧導線の設定画面統合**
  - `SettingsView` に開発者向け診断セクションを追加し、`DiagnosticsCenterView` から `DebugLogHistory` へ蓄積されたレイアウトログへ即座にアクセスできる導線を用意した。
  - 環境変数 `ENABLE_DIAGNOSTICS_MENU` により公開ビルドでメニューを無効化できるガードを実装し、リリース版ではユーザーから非表示にできるようにした。
- [x] **SharedSupport ログ管理画面の整備**
  - `DiagnosticsCenterView` で `DebugLogHistory` と `CrashFeedbackCollector` の履歴閲覧・削除・保持切替を一元管理できる UI を構築した。
  - 運用ガイドラインを `docs/refactoring-guidelines.md` などへ追記し、TestFlight 運用時のログ確認手順と無効化方法を明文化した。

## 中期（スプリント 3 以降）で着手するタスク
1. **ゲームモード拡張を見据えたパラメータ整理**
   - `GameMode` のペナルティや手札ロジックをドキュメントとテストで再確認し、キャンペーン専用ルール追加時の破綻を防ぐ。
   - `GameSessionTimer` など責務分離済みコンポーネントの再利用指針をまとめ、モードごとの調整が可能な設計へ寄せる。
2. **サービス層のモックシナリオ拡充**
   - ATT/UMP 同意フローと広告頻度の UX 検証を自動テストに取り込み、キャンペーンモードでの広告タイミング検証を容易にする。
3. **開発者向けドキュメント強化**
   - リファクタリング成果、ログ活用手順、テスト実行フローを `docs/refactoring-guidelines.md` などの関連ガイドへ追記し、次フェーズ移行時の参照性を高める。

## キャンペーンモード移行前の完了条件
- 上記短期タスクが完了し、UI・ゲームコア・サービス層の回帰テストとログ診断導線が整備されていること。
- `docs/recommended-task-list.md` の該当項目（統合テスト・ログ導線・ログポリシー）が「完了」に更新され、運用チームが新モード実装後の QA フローを共有できる状態になっていること。
- SharedSupport 経由のログ監視とクラッシュ収集が TestFlight 運用で実証され、キャンペーンモードで追加されるシナリオにも再利用可能であること。

## 次のアクション
- 本ドキュメントを Sprint プランニングの基準とし、進捗はスプリントレビュー時に更新する。
- タスク完了後はキャンペーンモードの仕様定義とプロトタイプ作成に着手する。
