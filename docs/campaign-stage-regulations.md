# キャンペーンステージ レギュレーション一覧

<!-- ドキュメント冒頭で目的と更新方針を共有し、参照者の期待値をそろえる -->
MonoKnight のキャンペーンモードに収録されている各ステージのレギュレーション（盤面・山札・ペナルティ・ギミック・スター条件）を
最新実装に基づいて整理する。実装の一次情報は `Game/CampaignStage.swift` および `Game/GameMode.swift` の `Regulation` 定義であるため、
ステージを追加・更新する際は必ずコードと本書を同時に改訂する。<!-- ドキュメント先行で乖離が生じないよう明記 -->

## 1. サマリー

<!-- チームが全体像を俯瞰できるよう一覧表を用意する -->
| ステージ | 盤面 / スポーン | 山札プリセット | 特殊タイル | セカンダリ条件 | スコア上限 | ペナルティ設定 | アンロック条件 |
|----------|-----------------|----------------|------------|----------------|------------|-----------------|----------------|
| 1-1 王将訓練 | 3×3 / 中央固定 | `kingOnly` | なし | 120 秒以内クリア | 900 未満 | +2 / +2 / +1 / +1 | 初期解放 |
| 1-2 序盤応用 | 4×4 / 中央固定 | `standard` | なし | ペナルティ 5 回以下 | 350 未満 | +3 / +1 / +1 / 0 | 1-1 クリア |
| 2-1 重踏応用 | 4×4 / 中央固定 | `standard` | 二度踏み ×2 | ペナルティ 5 回以下 | 350 未満 | +3 / +1 / +1 / 0 | 1-2 クリア |
| 3-1 縦横選択訓練 | 5×5 / 中央固定 | `standardWithOrthogonalChoices` | なし | ペナルティなし | 600 以下 | +5 / +5 / +1 / 0 | 2-1 クリア |
| 3-2 斜め選択応用 | 5×5 / 中央固定 | `standardWithDiagonalChoices` | なし | 32 手以内 | 580 以下 | +5 / +5 / +1 / 0 | 3-1 クリア |
| 3-3 桂馬選択攻略 | 5×5 / 中央固定 | `standardWithKnightChoices` | なし | 30 手以内 | 560 以下 | +5 / +5 / +1 / 0 | 3-2 クリア |
| 3-4 総合選択演習 | 5×5 / 中央固定 | `standardWithAllChoices` | なし | 28 手以内 | 540 未満 | +5 / +5 / +1 / 0 | 3-3 クリア |
| 4-1 反転制御訓練 | 5×5 / 中央固定 | `standard` | トグル ×2 | 30 手以内 | 520 以下 | +5 / +5 / +1 / 0 | 3-4 クリア |
| 5-1 障害物突破演習 | 5×5 / 中央固定 | `standardWithAllChoices` | 障害物 ×2 | 27 手以内 | 500 未満 | +5 / +5 / +1 / 0 | 4-1 クリア |

> **注記:** ペナルティ欄は `deadlock / manualRedraw / manualDiscard / revisit` の順で手数加算量を記載。<!-- 記法を明示 -->

## 2. ステージ設定共通仕様

<!-- ステージ追加時に確認すべきパラメータ群を整理する -->
- **定義ファイル**: `CampaignLibrary.buildChapters()` にステージを追加し、`CampaignStage` 初期化時に `GameMode.Regulation` を渡す。
- **盤面サイズ (`boardSize`)**: 現状は 3×3〜5×5。サイズ拡張時は手数目標とスコア上限の再調整が必須。
- **スポーン (`spawnRule`)**: 既存ステージはすべて `fixed(BoardGeometry.defaultSpawnPoint)`。ランダム/選択スポーン導入時は UI と連携する。
- **手札・先読み (`handSize` / `nextPreviewCount`)**: 全ステージで手札 5 種類・先読み 3 枚。同種カードスタックは常時有効。
- **山札 (`deckPreset`)**: `GameDeckPreset` 列挙を指定。プリセットに存在しないカードを直接追加しないこと。<!-- Deck テスト失敗を防止 -->
- **ペナルティ (`GameMode.PenaltySettings`)**: `deadlock`・`manualRedraw`・`manualDiscard`・`revisit` の 4 種を整数手数で指定。
- **追加踏破マス (`additionalVisitRequirements`)**: `GridPoint: Int` の辞書で管理。値は必要踏破回数。<!-- 二度踏みマスの再現に利用 -->
- **トグルマス (`toggleTilePoints`)**: `Set<GridPoint>`。同座標に追加踏破設定がある場合、トグルが優先され踏破状態が反転。<!-- 優先順位を明確化 -->
- **障害物 (`impassableTilePoints`)**: `Set<GridPoint>`。カード候補から除外され、移動不可。
- **スター条件**: `secondaryObjective`（手数・時間・ペナルティ・再訪禁止）と `scoreTarget`（閾値 + 比較方式）の二段構成。UI テキストは `CampaignStage` が生成。
- **アンロック条件**: `CampaignStageUnlockRequirement` を利用。総スター数ではなくステージクリアが条件のケースに注意。

## 3. 山札プリセット一覧

<!-- 実装済みプリセットの構成と抽選特徴をまとめる -->
| プリセット ID | 構成内容 | 抽選重み / 抑制 | 主な用途 |
|----------------|-----------|-----------------|-----------|
| `kingOnly` | キング型 8 種のみ | 均等重み / 抑制なし | 3×3 初学者訓練 (1-1)。 |
| `standard` | `MoveCard.standardSet` 24 種 | 均等重み / 直前カードを 5 ターン間 3/4 に減衰 | 4×4〜5×5 の基礎ステージ。 |
| `standardWithOrthogonalChoices` | 標準 + 上下左右選択キング 2 種 | 均等重み / 減衰あり | 3-1 の選択カード導入。 |
| `standardWithDiagonalChoices` | 標準 + 斜め選択キング 4 種 | 均等重み / 減衰あり | 3-2 の角操作練習。 |
| `standardWithKnightChoices` | 標準 + 桂馬選択 4 種 | 均等重み / 減衰あり | 3-3 のジャンプ練習。 |
| `standardWithAllChoices` | 標準 + 全選択カード 10 種 | 均等重み / 減衰あり | 3-4・5-1 の総合演習。 |

> **補足:** 現行実装では選択カードに個別重みの上書きは設定していない。調整が必要になった場合は `Deck.Configuration.WeightProfile` の `overrides` を更新する。<!-- コード変更ポイントを明記 -->

## 4. ペナルティ設定一覧

<!-- ステージ別に採用しているペナルティ値を比較し、バランス確認を容易にする -->
| 適用範囲 | deadlock | manualRedraw | manualDiscard | revisit | 備考 |
|-----------|----------|--------------|---------------|---------|------|
| 章 1-1 | +2 | +2 | +1 | +1 | クラシカルチャレンジ相当。 |
| 章 1-2 / 2-1 | +3 | +1 | +1 | 0 | 序盤応用用の緩和設定。 |
| 章 3-1〜5-1 | +5 | +5 | +1 | 0 | スタンダード準拠。 |

## 5. 実装済みギミック

<!-- ギミック挙動を定義し、ステージ設計時の誤用を防ぐ -->
- **二度踏みマス**: `(0,1)`・`(2,3)`（内部座標）。`additionalVisitRequirements` に値 `2` を設定。1 回目では未踏扱いのまま。
- **トグルマス**: `(0,1)`・`(2,3)`（内部座標）。`toggleTilePoints` に登録し、踏むたびに踏破⇔未踏を反転。
- **障害物マス**: `(0,1)`・`(2,3)`（内部座標）。`impassableTilePoints` に登録し、移動候補から除外。
- **ヒントホットスポット / 手札補充ブースト**: 実装済みだがキャンペーンでは未使用。将来採用時は本書へ追記する。<!-- 今後の運用余地を示す -->

## 6. 章別詳細

<!-- 各章のテーマとステージ仕様を丁寧に整理し、議論時の参照性を高める -->
# 第1章「基礎訓練」 改訂版レギュレーション

* **テーマ**: 小盤面から始め、移動カードと盤面拡張に慣れる。
* **スポーン**: 基本は中央固定、一部ステージで「任意位置スポーン」を導入。
* **ペナルティ**: 章全体で軽め（deadlock +2〜+3 / redraw +1〜+2 / discard +1 / revisit 0〜+1）。

---

## ステージ一覧

| ステージ      | 盤面 / スポーン          | 山札プリセット                        | 特殊タイル | セカンダリ条件     | スコア上限  | ペナルティ設定           | アンロック条件 |
| --------- | ------------------ | ------------------------------ | ----- | ----------- | ------ | ----------------- | ------- |
| 1-1 王将訓練  | 3×3 / 中央固定         | `kingOnly`                     | なし    | 120 秒以内     | 900 未満 | +2 / +2 / +1 / +1 | 初期解放    |
| 1-2 ナイト初見 | 3×3 / 中央固定         | `king+knightOnly`（新）           | なし    | ペナルティ 5 回以下 | 800 未満 | +2 / +2 / +1 / 0  | 1-1 クリア |
| 1-3 4×4基礎 | 4×4 / 中央固定         | `kingAndKnightBasic`（新）        | なし    | 60 秒以内      | 600 未満 | +3 / +1 / +1 / 0  | 1-2 クリア |
| 1-4 4×4応用 | 4×4 / **任意位置スポーン** | `kingAndKnightBasic`           | なし    | ペナルティ 3 回以下 | 550 未満 | +3 / +1 / +1 / 0  | 1-3 クリア |
| 1-5 4×4持久 | 4×4 / 中央固定         | `standardLight`（標準から大移動カードを減衰） | なし    | 30 手以内      | 500 未満 | +3 / +2 / +1 / 0  | 1-4 クリア |
| 1-6 4×4戦略 | 4×4 / **任意位置スポーン** | `kingAndKnightBasic`           | なし    | ペナルティ 2 回以下 | 480 未満 | +3 / +2 / +1 / 0  | 1-5 クリア |
| 1-7 5×5導入 | 5×5 / 中央固定         | `standardLight`                | なし    | 40 手以内      | 460 未満 | +3 / +2 / +1 / 0  | 1-6 クリア |
| 1-8 総合演習  | 5×5 / **任意位置スポーン** | `standardLight`                | なし    | 35 手以内      | 440 未満 | +3 / +2 / +1 / 0  | 1-7 クリア |

---

## 補足

* **任意スポーン導入**: 1-4, 1-6, 1-8 に採用。運要素を排しつつ戦略性を強化。
* **山札プリセット**

  * `king+knightOnly`: 1-2 限定、キング4種＋ナイト4種など軽量構成。
  * `kingAndKnightBasic`: 1-3 以降の標準。キング8種＋ナイト8種のみ。
  * `standardLight`: `standard` から直線2・斜め2を減衰。
* **ペナルティ**: 全体的に軽め (+2〜+3) に統一。2章以降で標準準拠(+5)へ移行させる。


### 第 2 章「応用特訓」
- テーマ: 追加踏破マスの導入。
- ギミック: `(0,1)`・`(2,3)` に二度踏みマス。
- ペナルティ: 章 1-2 と同一設定（+3/+1/+1/0）。

#### 2-1 重踏応用
- 盤面: 4×4、中央固定スポーン。
- 山札: `GameDeckPreset.standard`。
- ギミック: 上記二度踏みマス。
- セカンダリ条件: ペナルティ発生 5 回以下。
- スコア上限: 350 未満（`lessThan`）。
- アンロック: ステージ 1-2 クリア。

### 第 3 章「多方向訓練」
- テーマ: 選択式カードの段階的導入。
- 共通設定: 5×5 盤、中央固定スポーン、手札 5 種、先読み 3 枚、スタック可。
- ペナルティ: スタンダード準拠（+5/+5/+1/0）。

#### 3-1 縦横選択訓練
- 山札: `GameDeckPreset.standardWithOrthogonalChoices`。
- セカンダリ条件: ペナルティなしでクリア。
- スコア上限: 600 以下（`lessThanOrEqual`）。
- アンロック: ステージ 2-1 クリア。

#### 3-2 斜め選択応用
- 山札: `GameDeckPreset.standardWithDiagonalChoices`。
- セカンダリ条件: 32 手以内にクリア。
- スコア上限: 580 以下（`lessThanOrEqual`）。
- アンロック: ステージ 3-1 クリア。

#### 3-3 桂馬選択攻略
- 山札: `GameDeckPreset.standardWithKnightChoices`。
- セカンダリ条件: 30 手以内にクリア。
- スコア上限: 560 以下（`lessThanOrEqual`）。
- アンロック: ステージ 3-2 クリア。

#### 3-4 総合選択演習
- 山札: `GameDeckPreset.standardWithAllChoices`。
- セカンダリ条件: 28 手以内にクリア。
- スコア上限: 540 未満（`lessThan`）。
- アンロック: ステージ 3-3 クリア。

### 第 4 章「反転応用」
- テーマ: トグルマスによる踏破状態の制御。
- ギミック: `(0,1)`・`(2,3)` にトグルマス。
- ペナルティ: スタンダード準拠（+5/+5/+1/0）。

#### 4-1 反転制御訓練
- 盤面: 5×5、中央固定スポーン。
- 山札: `GameDeckPreset.standard`。
- ギミック: 上記トグルマス。
- セカンダリ条件: 30 手以内にクリア。
- スコア上限: 520 以下（`lessThanOrEqual`）。
- アンロック: ステージ 3-4 クリア。

### 第 5 章「障害物攻略」
- テーマ: 移動不可マスを避けるルート構築。
- ギミック: `(0,1)`・`(2,3)` に障害物マス。
- ペナルティ: スタンダード準拠（+5/+5/+1/0）。

#### 5-1 障害物突破演習
- 盤面: 5×5、中央固定スポーン。
- 山札: `GameDeckPreset.standardWithAllChoices`。
- ギミック: 上記障害物マス。
- セカンダリ条件: 27 手以内にクリア。
- スコア上限: 500 未満（`lessThan`）。
- アンロック: ステージ 4-1 クリア。

## 7. 更新手順とチェックリスト

<!-- 運用フローを明文化して、ステージ調整時の抜け漏れを防ぐ -->
1. `Game/CampaignStage.swift` の該当ステージを更新し、必要に応じてユニットテスト（`Tests/GameTests/CampaignLibraryTests` など）を調整する。
2. 本書と [`docs/game-rules-handbook.md`](game-rules-handbook.md) を改訂し、仕様差分を明記する。
3. QA 用チェックリストを更新し、ギミック・スター条件の検証観点を反映する。
4. PR で変更理由とテスト結果を共有し、レビュー時にドキュメントとの整合性を確認する。<!-- チーム内の認識差分を減らす -->

