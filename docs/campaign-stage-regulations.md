# キャンペーンステージ レギュレーション一覧

<!-- ドキュメント冒頭で目的と更新方針を共有し、参照者の期待値をそろえる -->
MonoKnight のキャンペーンモードに収録されている各ステージのレギュレーション（盤面・山札・ペナルティ・ギミック・スター条件）を
最新実装に基づいて整理する。実装の一次情報は `Game/CampaignStage.swift` および `Game/GameMode.swift` の `Regulation` 定義であるため、
ステージを追加・更新する際は必ずコードと本書を同時に改訂する。<!-- ドキュメント先行で乖離が生じないよう明記 -->

## 1. サマリー

<!-- チームが全体像を俯瞰できるよう一覧表を用意する -->
| ステージ | 盤面 / スポーン | 山札プリセット | 特殊タイル | セカンダリ条件 | スコア上限 | ペナルティ設定 | アンロック条件 |
|----------|-----------------|----------------|------------|----------------|------------|-----------------|----------------|
| 1-1 王将訓練 | 3×3 / 中央固定 | `kingOnly` | なし | 120 秒以内クリア | 900 未満 | +2 / +2 / +1 / +1 | 初期解放 |
| 1-2 ナイト初見 | 3×3 / 中央固定 | `kingPlusKnightOnly` | なし | ペナルティ 5 回以下 | 800 未満 | +2 / +2 / +1 / 0 | 1-1 クリア |
| 1-3 4×4基礎 | 4×4 / 中央固定 | `kingAndKnightBasic` | なし | 60 秒以内 | 600 未満 | +3 / +1 / +1 / 0 | 1-2 クリア |
| 1-4 4×4応用 | 4×4 / 任意スポーン | `kingAndKnightBasic` | なし | ペナルティ 3 回以下 | 550 未満 | +3 / +1 / +1 / 0 | 1-3 クリア |
| 1-5 4×4持久 | 4×4 / 中央固定 | `standardLight` | なし | 30 手以内 | 500 未満 | +3 / +2 / +1 / 0 | 1-4 クリア |
| 1-6 4×4戦略 | 4×4 / 任意スポーン | `kingAndKnightBasic` | なし | ペナルティ 2 回以下 | 480 未満 | +3 / +2 / +1 / 0 | 1-5 クリア |
| 1-7 5×5導入 | 5×5 / 中央固定 | `standardLight` | なし | 40 手以内 | 460 未満 | +3 / +2 / +1 / 0 | 1-6 クリア |
| 1-8 総合演習 | 5×5 / 任意スポーン | `standardLight` | なし | 35 手以内 | 440 未満 | +3 / +2 / +1 / 0 | 1-7 クリア |
| 2-1 重踏応用 | 4×4 / 中央固定 | `standard` | 二度踏み ×2 | ペナルティ 5 回以下 | 350 未満 | +3 / +1 / +1 / 0 | 1-2 クリア |
| 3-1 縦横選択訓練 | 5×5 / 中央固定 | `standardWithOrthogonalChoices` | なし | ペナルティなし | 600 以下 | +5 / +5 / +1 / 0 | 2-1 クリア |
| 3-2 斜め選択応用 | 5×5 / 中央固定 | `standardWithDiagonalChoices` | なし | 32 手以内 | 580 以下 | +5 / +5 / +1 / 0 | 3-1 クリア |
| 3-3 桂馬選択攻略 | 5×5 / 中央固定 | `standardWithKnightChoices` | なし | 30 手以内 | 560 以下 | +5 / +5 / +1 / 0 | 3-2 クリア |
| 3-4 総合選択演習 | 5×5 / 中央固定 | `standardWithAllChoices` | なし | 28 手以内 | 540 未満 | +5 / +5 / +1 / 0 | 3-3 クリア |
| 4-1 反転制御訓練 | 5×5 / 中央固定 | `standard` | トグル ×2 | 30 手以内 | 520 以下 | +5 / +5 / +1 / 0 | 3-4 クリア |
| 5-1 障害物突破演習 | 5×5 / 中央固定 | `standardWithAllChoices` | 障害物 ×2 | 27 手以内 | 500 未満 | +5 / +5 / +1 / 0 | 4-1 クリア |

> **注記:** ペナルティ欄は `deadlock / manualRedraw / manualDiscard / revisit` の順で手数加算量を記載。<!-- 記法を明示 -->

## 2. ステージ設定共通仕様

<!-- ステージ追加時に確認すべきパラメータ群を整理する -->
- **定義ファイル**: `CampaignLibrary.buildChapters()` にステージを追加し、`CampaignStage` 初期化時に `GameMode.Regulation` を渡す。
- **盤面サイズ (`boardSize`)**: 現状は 3×3〜5×5。サイズ拡張時は手数目標とスコア上限の再調整が必須。
- **スポーン (`spawnRule`)**: 既存ステージはすべて `fixed(BoardGeometry.defaultSpawnPoint)`。ランダム/選択スポーン導入時は UI と連携する。
- **手札・先読み (`handSize` / `nextPreviewCount`)**: 全ステージで手札 5 種類・先読み 3 枚。同種カードスタックは常時有効。
- **山札 (`deckPreset`)**: `GameDeckPreset` 列挙を指定。プリセットに存在しないカードを直接追加しないこと。<!-- Deck テスト失敗を防止 -->
- **ペナルティ (`GameMode.PenaltySettings`)**: `deadlock`・`manualRedraw`・`manualDiscard`・`revisit` の 4 種を整数手数で指定。
- **追加踏破マス (`additionalVisitRequirements`)**: `GridPoint: Int` の辞書で管理。値は必要踏破回数。<!-- 二度踏みマスの再現に利用 -->
- **トグルマス (`toggleTilePoints`)**: `Set<GridPoint>`。同座標に追加踏破設定がある場合、トグルが優先され踏破状態が反転。<!-- 優先順位を明確化 -->
- **障害物 (`impassableTilePoints`)**: `Set<GridPoint>`。カード候補から除外され、移動不可。
- **スター条件**: `secondaryObjective`（手数・時間・ペナルティ・再訪禁止）と `scoreTarget`（閾値 + 比較方式）の二段構成。UI テキストは `CampaignStage` が生成。
- **アンロック条件**: `CampaignStageUnlockRequirement` を利用。総スター数ではなくステージクリアが条件のケースに注意。

## 3. 山札プリセット一覧

<!-- 実装済みプリセットの構成と抽選特徴をまとめる -->
| プリセット ID | 構成内容 | 抽選重み / 抑制 | 主な用途 |
|----------------|-----------|-----------------|-----------|
| `kingOnly` | キング型 8 種のみ | 均等重み / 抑制なし | 3×3 初学者訓練 (1-1)。 |
| `standard` | `MoveCard.standardSet` 24 種 | 均等重み / 直前カードを 5 ターン間 3/4 に減衰 | 4×4〜5×5 の基礎ステージ。 |
| `standardWithOrthogonalChoices` | 標準 + 上下左右選択キング 2 種 | 均等重み / 減衰あり | 3-1 の選択カード導入。 |
| `standardWithDiagonalChoices` | 標準 + 斜め選択キング 4 種 | 均等重み / 減衰あり | 3-2 の角操作練習。 |
| `standardWithKnightChoices` | 標準 + 桂馬選択 4 種 | 均等重み / 減衰あり | 3-3 のジャンプ練習。 |
| `standardWithAllChoices` | 標準 + 全選択カード 10 種 | 均等重み / 減衰あり | 3-4・5-1 の総合演習。 |

> **補足:** 現行実装では選択カードに個別重みの上書きは設定していない。調整が必要になった場合は `Deck.Configuration.WeightProfile` の `overrides` を更新する。<!-- コード変更ポイントを明記 -->

## 4. ペナルティ設定一覧

<!-- ステージ別に採用しているペナルティ値を比較し、バランス確認を容易にする -->
| 適用範囲 | deadlock | manualRedraw | manualDiscard | revisit | 備考 |
|-----------|----------|--------------|---------------|---------|------|
| 章 1-1 | +2 | +2 | +1 | +1 | 王将のみの超序盤設定。 |
| 章 1-2 | +2 | +2 | +1 | 0 | キング＋桂馬限定でペナルティ軽減。 |
| 章 1-3 / 1-4 / 2-1 | +3 | +1 | +1 | 0 | 4×4 基礎〜応用および二度踏み練習。 |
| 章 1-5〜1-8 | +3 | +2 | +1 | 0 | 任意スポーン含む持久・戦略ステージ。 |
| 章 3-1〜5-1 | +5 | +5 | +1 | 0 | スタンダード準拠。 |

## 5. 実装済みギミック

<!-- ギミック挙動を定義し、ステージ設計時の誤用を防ぐ -->
- **二度踏みマス**: `(0,1)`・`(2,3)`（内部座標）。`additionalVisitRequirements` に値 `2` を設定。1 回目では未踏扱いのまま。
- **トグルマス**: `(0,1)`・`(2,3)`（内部座標）。`toggleTilePoints` に登録し、踏むたびに踏破⇔未踏を反転。
- **障害物マス**: `(0,1)`・`(2,3)`（内部座標）。`impassableTilePoints` に登録し、移動候補から除外。
- **ヒントホットスポット / 手札補充ブースト**: 実装済みだがキャンペーンでは未使用。将来採用時は本書へ追記する。<!-- 今後の運用余地を示す -->

## 6. 章別詳細

<!-- 各章のテーマとステージ仕様を丁寧に整理し、議論時の参照性を高める -->
# 第1章「基礎訓練」 改訂版レギュレーション

* **テーマ**: 小盤面から始め、移動カードと盤面拡張に慣れる。
* **スポーン**: 基本は中央固定、一部ステージで「任意位置スポーン」を導入。
* **ペナルティ**: 章全体で軽め（deadlock +2〜+3 / redraw +1〜+2 / discard +1 / revisit 0〜+1）。

---

## ステージ一覧

| ステージ      | 盤面 / スポーン          | 山札プリセット                        | 特殊タイル | セカンダリ条件     | スコア上限  | ペナルティ設定           | アンロック条件 |
| --------- | ------------------ | ------------------------------ | ----- | ----------- | ------ | ----------------- | ------- |
| 1-1 王将訓練  | 3×3 / 中央固定         | `kingOnly`                     | なし    | 120 秒以内     | 900 未満 | +2 / +2 / +1 / +1 | 初期解放    |
| 1-2 ナイト初見 | 3×3 / 中央固定         | `kingPlusKnightOnly`             | なし    | ペナルティ 5 回以下 | 800 未満 | +2 / +2 / +1 / 0  | 1-1 クリア |
| 1-3 4×4基礎 | 4×4 / 中央固定         | `kingAndKnightBasic`（新）        | なし    | 60 秒以内      | 600 未満 | +3 / +1 / +1 / 0  | 1-2 クリア |
| 1-4 4×4応用 | 4×4 / **任意位置スポーン** | `kingAndKnightBasic`           | なし    | ペナルティ 3 回以下 | 550 未満 | +3 / +1 / +1 / 0  | 1-3 クリア |
| 1-5 4×4持久 | 4×4 / 中央固定         | `standardLight`（標準から大移動カードを減衰） | なし    | 30 手以内      | 500 未満 | +3 / +2 / +1 / 0  | 1-4 クリア |
| 1-6 4×4戦略 | 4×4 / **任意位置スポーン** | `kingAndKnightBasic`           | なし    | ペナルティ 2 回以下 | 480 未満 | +3 / +2 / +1 / 0  | 1-5 クリア |
| 1-7 5×5導入 | 5×5 / 中央固定         | `standardLight`                | なし    | 40 手以内      | 460 未満 | +3 / +2 / +1 / 0  | 1-6 クリア |
| 1-8 総合演習  | 5×5 / **任意位置スポーン** | `standardLight`                | なし    | 35 手以内      | 440 未満 | +3 / +2 / +1 / 0  | 1-7 クリア |

---

## 補足

* **任意スポーン導入**: 1-4, 1-6, 1-8 に採用。運要素を排しつつ戦略性を強化。
* **山札プリセット**

  * `kingPlusKnightOnly`: 1-2 限定、キング4種＋ナイト4種など軽量構成。
  * `kingAndKnightBasic`: 1-3 以降の標準。キング8種＋ナイト8種のみ。
  * `standardLight`: `standard` から直線2・斜め2を減衰。
* **ペナルティ**: 全体的に軽め (+2〜+3) に統一。2章以降で標準準拠(+5)へ移行させる。


# 第2章「応用特訓（重踏）」 改訂版レギュレーション（踏破回数 2〜4 回対応）

* **新要素**: 多重踏破マス（`additionalVisitRequirements`）。指定マスを **2/3/4 回** 踏むまで未踏扱い。
* **基本盤面**: 原則 **5×5**。**2-1 のチュートリアルのみ 4×4** を許可。
* **スポーン**: 2-1 は中央固定、それ以外は **任意位置スポーン（chooseAnyAfterPreview）**。
* **手札/先読み**: 手札 5 種、先読み 3 枚、同種スタック可（全ステージ共通）。
* **山札**: `kingAndKnightBasic`（キング8種＋ナイト8種のみ。選択式カードは未導入）。
* **ペナルティ**: 章全体で軽め（`deadlock +3 / manualRedraw +1 / manualDiscard +1 / revisit 0`）。

---

## ステージ一覧（8ステージ）

| ステージ                   | 盤面 / スポーン      | 踏破要求マス（例）               | 要求回数       | セカンダリ条件     | スコア上限      | ペナルティ設定          | アンロック条件 |
| ---------------------- | -------------- | ----------------------- | ---------- | ----------- | ---------- | ---------------- | ------- |
| **2-1 重踏チュートリアル**      | **4×4 / 中央固定** | (1,1),(2,2)             | **2回**     | ペナルティ 5 回以下 | **620 以下** | +3 / +1 / +1 / 0 | 1-8 クリア |
| **2-2 基礎演習（5×5導入）**    | **5×5 / 任意**   | (1,1),(3,3)             | **各2回**    | 45 手以内      | **600 以下** | +3 / +1 / +1 / 0 | 2-1 クリア |
| **2-3 三重踏み入門**         | 5×5 / 任意       | (2,2)                   | **3回**     | 42 手以内      | 590 以下     | +3 / +1 / +1 / 0 | 2-2 クリア |
| **2-4 応用（複数三重踏み）**     | 5×5 / 任意       | (1,1),(3,3)             | **各3回**    | ペナルティ 3 回以下 | 580 以下     | +3 / +1 / +1 / 0 | 2-3 クリア |
| **2-5 中央集中（四重踏み1点）**   | 5×5 / 任意       | (2,2)                   | **4回**     | 40 手以内      | 570 以下     | +3 / +1 / +1 / 0 | 2-4 クリア |
| **2-6 四重踏み分散**         | 5×5 / 任意       | (1,1),(3,3)             | **各4回**    | 130 秒以内     | 560 以下     | +3 / +1 / +1 / 0 | 2-5 クリア |
| **2-7 複合課題（2回＋3回＋4回）** | 5×5 / 任意       | (0,0),(2,2),(4,4)       | **2/3/4回** | 36 手以内      | 550 以下     | +3 / +1 / +1 / 0 | 2-6 クリア |
| **2-8 総合演習**           | 5×5 / 任意       | (0,0),(4,0),(0,4),(4,4) | **各3回**    | 34 手以内      | **540 以下** | +3 / +1 / +1 / 0 | 2-7 クリア |

> **注記**: 座標は内部座標（左下原点 (0,0)）。示した位置はサンプルであり、実装・QA で最終調整可。

---

## 章共通の実装パラメータ

* `spawnRule`

  * 2-1: `.fixed(BoardGeometry.defaultSpawnPoint)`
  * 2-2〜2-8: `.chooseAnyAfterPreview`
* `penaltySettings`: `.init(deadlock: 3, manualRedraw: 1, manualDiscard: 1, revisit: 0)`
* `deckPreset`: `.kingAndKnightBasic`

```swift
// 例: 2-6 の Regulation スケッチ
GameMode.Regulation(
    boardSize: 5,
    spawnRule: .chooseAnyAfterPreview,
    handSize: 5,
    nextPreviewCount: 3,
    deckPreset: .kingAndKnightBasic,
    penalty: .init(deadlock: 3, manualRedraw: 1, manualDiscard: 1, revisit: 0),
    additionalVisitRequirements: [
        GridPoint(x: 1, y: 1): 4,
        GridPoint(x: 3, y: 3): 4,
    ],
    toggleTilePoints: [],
    impassableTilePoints: []
)
```

---

## ステージ別 `additionalVisitRequirements`（座標例）

* **2-1** (4×4): `{(1,1):2, (2,2):2}`
* **2-2** (5×5): `{(1,1):2, (3,3):2}`
* **2-3**: `{(2,2):3}`
* **2-4**: `{(1,1):3, (3,3):3}`
* **2-5**: `{(2,2):4}`
* **2-6**: `{(1,1):4, (3,3):4}`
* **2-7**: `{(0,0):2, (2,2):3, (4,4):4}`
* **2-8**: `{(0,0):3, (4,0):3, (0,4):3, (4,4):3}`

---

## QA チェック観点（要点）

* **開始位置の選択肢**で詰みが出ないか（2-5, 2-6 は四重踏みのため手札シーケンス依存が強くなる）。
* **多重踏破の視覚化**: 未達回数（残り 1〜3）をタイル上に表示できているか。
* **deadlock 発生率**: 20 試行で 15% 以下を目安に。
* **スコア閾値**: 実測中央値＋1σを基準に都度チューニング。


# 第3章「多方向訓練（選択カード＋複数踏破）」 改訂版レギュレーション（ペナルティ例外反映）

- **新要素**: 選択式カード（縦横／斜め／桂馬／総合）。
- **再登場要素**: 2章の複数踏破マス（2〜4回要求）を後半から混在。
- **基本盤面**: 原則 **5×5**。**3-1 のチュートリアルのみ 4×4**。
- **スポーン**: 基本は中央固定。一部で **任意位置スポーン** を導入。
- **手札/先読み**: 手札 5 種、先読み 3 枚、同種スタック可。
- **山札**: `GameDeckPreset.*Choices` を段階導入。
- **ペナルティ**: 標準（`deadlock +5 / manualRedraw +5 / manualDiscard +1 / revisit 0`）。
  - **例外**: 「ペナルティなし」条件の **3-1 / 3-8** は **`deadlock=0` / `manualRedraw=0`** に変更（`manualDiscard=1` / `revisit=0` 維持）。

---

## ステージ一覧（8ステージ）

| ステージ | 盤面 / スポーン | 山札プリセット | 特殊タイル | セカンダリ条件 | スコア上限 | ペナルティ設定 | アンロック条件 |
|---|---|---|---|---|---|---|---|
| **3-1 縦横選択チュートリアル** | **4×4 / 中央固定** | `standardWithOrthogonalChoices` | なし | ペナルティなし | 600 以下 | **0 / 0 / +1 / 0** | 2-8 クリア |
| **3-2 縦横基礎** | **5×5 / 中央固定** | `standardWithOrthogonalChoices` | なし | 40 手以内 | 590 以下 | +5 / +5 / +1 / 0 | 3-1 クリア |
| **3-3 斜め選択入門** | 5×5 / 中央固定 | `standardWithDiagonalChoices` | なし | ペナルティ 2 回以下 | 580 以下 | +5 / +5 / +1 / 0 | 3-2 クリア |
| **3-4 桂馬選択入門** | 5×5 / 中央固定 | `standardWithKnightChoices` | なし | 38 手以内 | 570 以下 | +5 / +5 / +1 / 0 | 3-3 クリア |
| **3-5 選択＋二度踏み** | 5×5 / **任意** | `standardWithOrthogonalChoices` | 二度踏み (各2回要求) | 36 手以内 | 560 以下 | +5 / +5 / +1 / 0 | 3-4 クリア |
| **3-6 全選択A＋三重踏み** | 5×5 / 中央固定 | `standardWithAllChoices` | 三重踏み (各3回要求) | ペナルティ 1 回以下 | 550 以下 | +5 / +5 / +1 / 0 | 3-5 クリア |
| **3-7 全選択B＋四重踏み** | 5×5 / **任意** | `standardWithAllChoices` | 四重踏み (各4回要求) | 34 手以内 | 540 以下 | +5 / +5 / +1 / 0 | 3-6 クリア |
| **3-8 総合演習（全選択＋混合踏破）** | 5×5 / 中央固定 | `standardWithAllChoices` | 2回＋3回＋4回要求マス混合 | ノーペナ＆32手以内 | 530 以下 | **0 / 0 / +1 / 0** | 3-7 クリア |

---

## 実装パラメータ（抜粋）

- `boardSize`: 3-1 は 4、他は 5。
- `spawnRule`: 基本 `.fixed(BoardGeometry.defaultSpawnPoint)`、3-5・3-7 は `.chooseAnyAfterPreview`。
- `penaltySettings`: `.init(deadlock: 5, manualRedraw: 5, manualDiscard: 1, revisit: 0)`（※3-1/3-8 は `deadlock=0, manualRedraw=0` の例外）。
- `additionalVisitRequirements`: 3-5〜3-8 で使用。

# 第4章「反転応用（トグルマス＋複数踏破）」 改訂版レギュレーション

* **新要素**: トグルマス（踏むたびに踏破⇔未踏が反転）。
* **再登場要素**: 2章の複数踏破マス（2〜4回要求）。
* **基本盤面**: **5×5固定**。
* **スポーン**: 基本は中央固定。中盤以降で一部任意位置スポーン。
* **山札**: `standardLight` または `standardWithAllChoices` を使用。選択カードはすでに解禁済みのため自由度を高める。
* **ペナルティ**: 標準（`deadlock +5 / manualRedraw +5 / manualDiscard +1 / revisit 0`）。

  * **例外**: 「ペナルティなし」が条件のステージ（4-7, 4-8）は **`deadlock=0` / `manualRedraw=0`** に変更し達成可能化。`manualDiscard=1` / `revisit=0` は維持。

---

## ステージ一覧（8ステージ）

| ステージ                  | 盤面 / スポーン  | 山札プリセット                  | 特殊タイル                       | セカンダリ条件     | スコア上限  | ペナルティ設定          | アンロック条件 |
| --------------------- | ---------- | ------------------------ | --------------------------- | ----------- | ------ | ---------------- | ------- |
| **4-1 トグル基礎**         | 5×5 / 中央固定 | `standardLight`          | トグル×2（例: (1,1),(3,3)）       | 30 手以内      | 520 以下 | +5 / +5 / +1 / 0 | 3-8 クリア |
| **4-2 トグル応用**         | 5×5 / 中央固定 | `standardLight`          | トグル×3（例: (2,2),(1,3),(3,1)） | ペナルティ 2 回以下 | 510 以下 | +5 / +5 / +1 / 0 | 4-1 クリア |
| **4-3 トグル＋二度踏み**      | 5×5 / 中央固定 | `standardLight`          | トグル×2＋二度踏み×2                | 40 手以内      | 500 以下 | +5 / +5 / +1 / 0 | 4-2 クリア |
| **4-4 トグル＋三重踏み**      | 5×5 / 中央固定 | `standardWithAllChoices` | トグル×2＋三重踏み×1                | ペナルティ 1 回以下 | 490 以下 | +5 / +5 / +1 / 0 | 4-3 クリア |
| **4-5 トグル集中制御**       | 5×5 / 任意   | `standardWithAllChoices` | トグル×4                       | 38 手以内      | 480 以下 | +5 / +5 / +1 / 0 | 4-4 クリア |
| **4-6 トグル＋四重踏み**      | 5×5 / 任意   | `standardWithAllChoices` | トグル×2＋四重踏み×1                | 36 手以内      | 470 以下 | +5 / +5 / +1 / 0 | 4-5 クリア |
| **4-7 トグル＋複合踏破**      | 5×5 / 任意   | `standardWithAllChoices` | トグル×2＋二度踏み×2＋三重踏み×1         | ペナルティなし     | 460 以下 | 0 / 0 / +1 / 0   | 4-6 クリア |
| **4-8 総合演習（反転＋踏破混合）** | 5×5 / 中央固定 | `standardWithAllChoices` | トグル×3＋2/3/4回要求混合            | 34 手以内＆ノーペナ | 450 以下 | 0 / 0 / +1 / 0   | 4-7 クリア |

---

## 実装パラメータ

* `boardSize`: 常に 5。
* `spawnRule`: 基本 `.fixed(BoardGeometry.defaultSpawnPoint)`、4-5〜4-7 は `.chooseAnyAfterPreview`。
* `penaltySettings`: `.init(deadlock: 5, manualRedraw: 5, manualDiscard: 1, revisit: 0)`。
* `additionalVisitRequirements`: 4-3,4-4,4-6,4-7,4-8 で利用。
* `toggleTilePoints`: 全ステージで利用。4-1〜4-2 は基礎、後半は複合。
* `impassableTilePoints`: 未使用（5章以降で導入）。

```swift
// 例: 4-4 の Regulation スケッチ
GameMode.Regulation(
    boardSize: 5,
    spawnRule: .fixed(BoardGeometry.defaultSpawnPoint),
    handSize: 5,
    nextPreviewCount: 3,
    deckPreset: .standardWithAllChoices,
    penalty: .init(deadlock: 5, manualRedraw: 5, manualDiscard: 1, revisit: 0),
    additionalVisitRequirements: [
        GridPoint(x: 2, y: 2): 3
    ],
    toggleTilePoints: [
        GridPoint(x: 1, y: 1), GridPoint(x: 3, y: 3)
    ],
    impassableTilePoints: []
)
```

---

## 難易度曲線の意図

1. **4-1〜4-2**: トグル操作を学習。シンプルに2〜3個導入。
2. **4-3〜4-4**: トグル＋複数踏破を混合。操作の優先順位を考えさせる。
3. **4-5〜4-6**: 任意スポーンで戦略性UP。トグル多数＋四重踏み登場。
4. **4-7**: トグル＋複数踏破のフルセット。ノーペナ条件で緊張感を高める。
5. **4-8**: 総合演習。トグルと2/3/4回要求が同時に出る高難度試験。


# 第5章「障害物攻略（障害物＋複数踏破＋トグル）」 改訂版レギュレーション

* **新要素**: 障害物マス（移動不可）。
* **再登場要素**: 複数踏破（2〜4回要求）、トグルマス。
* **基本盤面**: **5×5固定**。
* **スポーン**: 基本は中央固定。中盤以降で一部任意位置スポーン。
* **山札**: `standardWithAllChoices` を中心に使用。
* **ペナルティ**: 標準（`deadlock +5 / manualRedraw +5 / manualDiscard +1 / revisit 0`）。

  * **例外**: 「ペナルティなし」条件のステージ（5-8）は **`deadlock=0` / `manualRedraw=0`** に変更。

---

## ステージ一覧（8ステージ）

| ステージ                     | 盤面 / スポーン  | 山札プリセット                  | 特殊タイル                     | セカンダリ条件     | スコア上限  | ペナルティ設定          | アンロック条件 |
| ------------------------ | ---------- | ------------------------ | ------------------------- | ----------- | ------ | ---------------- | ------- |
| **5-1 障害物基礎**            | 5×5 / 中央固定 | `standardWithAllChoices` | 障害物×2                     | 30 手以内      | 500 以下 | +5 / +5 / +1 / 0 | 4-8 クリア |
| **5-2 障害物応用**            | 5×5 / 中央固定 | `standardWithAllChoices` | 障害物×3                     | ペナルティ 2 回以下 | 490 以下 | +5 / +5 / +1 / 0 | 5-1 クリア |
| **5-3 障害物＋二度踏み**         | 5×5 / 中央固定 | `standardWithAllChoices` | 障害物×2＋二度踏み×2              | 40 手以内      | 480 以下 | +5 / +5 / +1 / 0 | 5-2 クリア |
| **5-4 障害物＋三重踏み**         | 5×5 / 任意   | `standardWithAllChoices` | 障害物×2＋三重踏み×1              | ペナルティ 1 回以下 | 470 以下 | +5 / +5 / +1 / 0 | 5-3 クリア |
| **5-5 障害物＋トグル**          | 5×5 / 中央固定 | `standardWithAllChoices` | 障害物×2＋トグル×2               | 38 手以内      | 460 以下 | +5 / +5 / +1 / 0 | 5-4 クリア |
| **5-6 複合（障害物＋四重踏み＋トグル）** | 5×5 / 任意   | `standardWithAllChoices` | 障害物×2＋四重踏み×1＋トグル×1        | 36 手以内      | 450 以下 | +5 / +5 / +1 / 0 | 5-5 クリア |
| **5-7 複合（多要素）**          | 5×5 / 任意   | `standardWithAllChoices` | 障害物×3＋二度踏み×1＋三重踏み×1＋トグル×1 | ペナルティなし     | 440 以下 | 0 / 0 / +1 / 0   | 5-6 クリア |
| **5-8 総合演習（最終試験）**       | 5×5 / 中央固定 | `standardWithAllChoices` | 障害物×3＋二度/三重/四重踏み混合＋トグル×2  | 34 手以内＆ノーペナ | 430 以下 | 0 / 0 / +1 / 0   | 5-7 クリア |

---

## 実装パラメータ

* `boardSize`: 常に 5。
* `spawnRule`: 基本 `.fixed(BoardGeometry.defaultSpawnPoint)`、5-4・5-6・5-7 は `.chooseAnyAfterPreview`。
* `penaltySettings`: `.init(deadlock: 5, manualRedraw: 5, manualDiscard: 1, revisit: 0)`（※5-7/5-8 は `deadlock=0, manualRedraw=0` へ例外設定）。
* `additionalVisitRequirements`: 5-3,5-4,5-6,5-7,5-8 で利用。
* `toggleTilePoints`: 5-5,5-6,5-7,5-8 で利用。
* `impassableTilePoints`: 全ステージで利用（障害物配置）。

```swift
// 例: 5-6 の Regulation スケッチ
GameMode.Regulation(
    boardSize: 5,
    spawnRule: .chooseAnyAfterPreview,
    handSize: 5,
    nextPreviewCount: 3,
    deckPreset: .standardWithAllChoices,
    penalty: .init(deadlock: 5, manualRedraw: 5, manualDiscard: 1, revisit: 0),
    additionalVisitRequirements: [
        GridPoint(x: 2, y: 2): 4
    ],
    toggleTilePoints: [
        GridPoint(x: 1, y: 1)
    ],
    impassableTilePoints: [
        GridPoint(x: 0, y: 2), GridPoint(x: 4, y: 2)
    ]
)
```

---

## 難易度曲線の意図

1. **5-1〜5-2**: 障害物基礎。通行不可マスを避ける思考習慣を作る。
2. **5-3〜5-4**: 障害物＋複数踏破で計画力を要求。
3. **5-5〜5-6**: 障害物＋トグル＋多重踏破の複合で負荷増大。
4. **5-7**: 複合要素フルセット＋ノーペナ条件。例外設定で達成可能化。
5. **5-8**: 最終試験。障害物・複数踏破・トグルをすべて組み合わせた総合演習。


## 7. 更新手順とチェックリスト

<!-- 運用フローを明文化して、ステージ調整時の抜け漏れを防ぐ -->
1. `Game/CampaignStage.swift` の該当ステージを更新し、必要に応じてユニットテスト（`Tests/GameTests/CampaignLibraryTests` など）を調整する。
2. 本書と [`docs/game-rules-handbook.md`](game-rules-handbook.md) を改訂し、仕様差分を明記する。
3. QA 用チェックリストを更新し、ギミック・スター条件の検証観点を反映する。
4. PR で変更理由とテスト結果を共有し、レビュー時にドキュメントとの整合性を確認する。<!-- チーム内の認識差分を減らす -->

