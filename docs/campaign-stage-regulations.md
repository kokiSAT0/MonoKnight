# キャンペーンステージ レギュレーション一覧

<!-- ドキュメント全体の概要を冒頭で説明し、後続セクションの参照性を高める -->
MonoKnight のキャンペーンモードに収録されている各ステージについて、盤面設定・山札プリセット・ペナルティ条件・ギミック配置などのレギュレーションを整理する。ゲームバランス調整やデバッグ作業で参照できるよう、章ごとのテーマと達成条件も併記する。

## サマリー

<!-- 開発メンバーが全体像を俯瞰しやすいよう、章横断の概要表を配置する -->
| ステージ | 盤面 / スポーン | 山札プリセット | 特殊ギミック | セカンダリ条件 | スコア目標 | 難度指標 (★1-5) | 推奨調整指針 | アンロック条件 |
|----------|-----------------|----------------|--------------|----------------|-------------|------------------|----------------|----------------|
| 1-1 王将訓練 | 3×3・中央固定スポーン | 王将構成 | 追加ギミックなし | 120 秒以内クリア | スコア 900 未満 | ★1 | 入門: 操作ガイド強化優先 | 初期解放 |
| 1-2 序盤応用 | 4×4・中央固定スポーン | スタンダード構成 | 追加ギミックなし | ペナルティ 5 回以下 | スコア 350 未満 | ★1.5 | 手札圧迫テスト | 1-1 クリア |
| 2-1 重踏応用 | 4×4・中央固定スポーン | スタンダード構成 | 二度踏みマス ×2 | ペナルティ 5 回以下 | スコア 350 未満 | ★2 | 二度踏み導入・踏破ログ確認 | 1-2 クリア |
| 3-1 縦横選択訓練 | 5×5・中央固定スポーン | 標準＋縦横選択キング構成 | 追加ギミックなし | ペナルティなしクリア | スコア 600 以下 | ★2.5 | 縦横選択カードバランス確認 | 2-1 クリア |
| 3-2 斜め選択応用 | 5×5・中央固定スポーン | 標準＋斜め選択キング構成 | 追加ギミックなし | 32 手以内クリア | スコア 580 以下 | ★3 | 斜め選択の密度調整 | 3-1 クリア |
| 3-3 桂馬選択攻略 | 5×5・中央固定スポーン | 標準＋桂馬選択構成 | 追加ギミックなし | 30 手以内クリア | スコア 560 以下 | ★3.5 | 桂馬選択の RNG ばらつき監視 | 3-2 クリア |
| 3-4 総合選択演習 | 5×5・中央固定スポーン | 標準＋全選択カード構成 | 追加ギミックなし | 28 手以内クリア | スコア 540 未満 | ★3.5 | 総合練習・難度平均化 | 3-3 クリア |
| 4-1 反転制御訓練 | 5×5・中央固定スポーン | スタンダード構成 | トグルマス ×2 | 30 手以内クリア | スコア 520 以下 | ★4 | トグル反転ループ監視 | 3-4 クリア |
| 5-1 障害物突破演習 | 5×5・中央固定スポーン | 標準＋全選択カード構成 | 障害物マス ×2 | 27 手以内クリア | スコア 500 未満 | ★4.5 | 経路誘導と RNG 調整 | 4-1 クリア |

<!-- 難度指標は QA の優先度付けに活用し、調整履歴を残す際の基準として利用する -->

## ステージ設定仕様

<!-- ステージ追加時に必ず参照すべき共通パラメータ群を整理する -->
- 盤面サイズ
  - 設定値: `3×3` / `4×4` / `5×5`（今後拡張予定: `6×6` / `7×7`）。
  - 調整観点: 盤面が拡大するほど踏破時間が延びるため、手数目標・スコア目標の下限を合わせて見直す。<!-- サイズ変更時の連動調整を明記 -->
- スポーン設定
  - `centralFixed`: 中央マス固定スポーン（既存ステージ全て）。
  - `customCoords(x,y)`: 任意マス開始（今後拡張時に使用）。
  - `randomWithinZone(zoneID)`: 指定ゾーン内からランダム（実装済みだが未使用、A/B テスト用）。
- 手札スロット / 先読み枚数
  - デフォルト: 手札 5 枠・先読み 3 枚・同一カードはスタック。
  - 調整時は `DeckConfig` の `handLimit`・`previewCount` を変更。手札枯渇頻度と RNG 依存度が変化するため、引き直しペナルティを同時に確認。
- 山札プリセット
  - `GameDeckPreset` 列挙を使用（下表参照）。プリセットに存在しないカードは Deck テストが失敗するため注意。
- ペナルティスキーム
  - `PenaltyProfile` で `deadEnd`（手詰まり）、`redraw`（引き直し）、`discard`（捨て札）、`revisit`（再訪）の各係数を設定。
  - 仕様書に記載の値は 1 アクションあたりの手数加算。スコア式は `手数×10 + 経過秒` に連動。
- セカンダリ条件
  - 代表例: 手数上限、時間制限、ペナルティ回数上限、特定ギミックの使用回数、特定マス踏破順序。
  - UI 表示テキストは `CampaignStageSecondaryCondition` のローカライズキーを利用。新条件追加時は `Localizable.strings` 更新必須。
- スコア目標
  - 「未満」「以下」「以上」などの比較演算子を明示。ランキング同期と報酬判定で使用するため、仕様差異がある場合は `StageScoreRule` に追記。
- アンロック条件
  - 原則として「前ステージの星 1 以上獲得」。複数条件の場合は `StageUnlockRequirement` に複合式を設定し、依存グラフをドキュメントへ追記。

### 山札プリセット一覧

<!-- 各プリセットが含むカード種と重みを明記し、バランス調整時の参考にする -->
| プリセット ID | 構成内容 | 基本重み | 備考 |
|----------------|-----------|----------|------|
| `kingOnly` | 王将カード 1 種（上下左右1マス移動） | 1.0 固定 | 3×3 など狭小盤用。チュートリアル向け。 |
| `standard` | 王将・縦横 2 マス・斜め 2 マス・桂馬（合計 16 種） | 1.0 均一 | キャンペーン標準構成。 |
| `standardWithOrthogonalChoices` | `standard` ＋ 縦横方向から 1 枚選択するカード 4 種 | 1.0 / 選択カードは 0.8 | 手札圧迫を抑えつつ移動自由度を提供。 |
| `standardWithDiagonalChoices` | `standard` ＋ 斜め方向から 1 枚選択するカード 4 種 | 1.0 / 選択カードは 0.8 | 斜め経路の意識づけ。 |
| `standardWithKnightChoices` | `standard` ＋ 桂馬方向から 1 枚選択するカード 4 種 | 1.0 / 選択カードは 0.9 | RNG 依存が高いため重み 0.9 で供給過多を抑制。 |
| `standardWithAllChoices` | `standard` ＋ 全選択カード 12 種 | 1.0 / 選択カードは 0.75 | 終盤難度向け。行動選択肢が多くなるためタイム条件を厳しめに設定。 |

### ペナルティプロファイル一覧

<!-- ペナルティ設定を統一管理し、ステージ間の不整合を防ぐ -->
| プロファイル名 | 手詰まり (deadEnd) | 引き直し (redraw) | 捨て札 (discard) | 再訪 (revisit) | 想定ステージ |
|----------------|---------------------|--------------------|------------------|----------------|----------------|
| `classicTight` | +2 | +2 | +1 | +1 | 1-1 など序盤訓練用 |
| `earlyRelaxed` | +3 | +1 | +1 | 0 | 1-2 / 2-1 |
| `standardCore` | +5 | +5 | +1 | 0 | 3 章以降の通常設定 |
| `hardcoreToggle` | +6 | +5 | +2 | +1 | トグル・障害物など高難度ステージ案（未使用） |

### 実装済みギミック一覧

<!-- ギミックの仕様と相互作用を整理し、誤った組合せを避ける -->
- **通常マス (NormalTile)**: 踏破すると踏破済みフラグが立つ。再訪時はペナルティ `revisit` が適用される。<!-- 基本挙動を明示 -->
- **二度踏みマス (DoubleStepTile)**
  - 2 回踏破で完了。`stepCountRequired = 2`。
  - ペナルティ: 未完了状態で離脱しても追加ペナルティは発生しない。クリア条件判定時は完全踏破が必須。
- **トグルマス (ToggleTile)**
  - 踏破状態が「踏破 / 未踏」を交互に切り替わる。盤面全踏破条件に影響。
  - 連続踏みでループしないよう、行動ログで直前にトグルを踏んでいる場合はヒント警告を表示する。<!-- UX の注意事項 -->
- **障害物マス (ObstacleTile)**
  - 駒の侵入不可。カード候補から除外されるため、手札事故率が上昇する。山札重み調整で遠距離カードを増やすなどフォローを検討。
- **スタートマス (SpawnTile)**
  - 盤面初期位置。`SpawnPattern` により複数候補がある場合は乱数シードに応じて選択される。既存ステージでは中央固定。
- **ヒントホットスポット (HintHotspot)**
  - チュートリアル向けに表示可能なガイドマーカー。実装済みだがキャンペーンでは未使用。今後の易化施策として活用可。
- **手札補充ブースト (HandRefillBoost)**
  - 一定ターンで山札重みをリセットし、使われていないカードを優先供給。内部テスト用に実装済み。難度調整時に有効化可能。

## ステージデータ定義フォーマット

<!-- データ駆動でステージを追加する際の YAML/JSON スキーマを共有 -->
```yaml
id: "3-2"              # ステージ ID。章-番号表記。
title: "斜め選択応用"    # UI 表示名。
board:
  size: 5               # 一辺の長さ。整数。
  spawn: centralFixed   # 初期位置パターン。
  tiles:                # 特殊マス定義。座標は 0 始まり。
    - type: doubleStep
      coord: [0, 1]
    - type: doubleStep
      coord: [2, 3]
deckPreset: standardWithDiagonalChoices
handLimit: 5
previewCount: 3
penaltyProfile: standardCore
secondaryConditions:
  - type: maxTurn
    value: 32
  - type: penaltyFree
scoreRule:
  comparison: "<="
  target: 580
unlock:
  - stage: "3-1"
rewards:
  stars:
    - requirement: "clear"
      threshold: null
    - requirement: "score"
      threshold: 560
```

<!-- 実装では Swift の Codable でパース。追加フィールドはバージョン互換性に留意する -->

## バランス調整フロー

<!-- 調整チームが共通フローを追えるように手順を明文化 -->
1. **目的整理**: KPI（クリア率 / 平均手数 / 離脱率）を定義し、対象ステージを選定。
2. **現状把握**: `SharedSupport/telemetry` に蓄積されたリプレイログを抽出し、ターン数・ペナルティ回数を分析。
3. **仮説立案**: 山札重み調整・ギミック追加・セカンダリ条件変更など、想定改善策を洗い出す。
4. **設定更新**: 本ドキュメントの該当セクションを更新後、`Game/CampaignStages.swift` のデータを同期。<!-- ドキュメント先行で必ず差分を残す -->
5. **QA 実施**: 自動テスト（ユニット）＋ マニュアルプレイ 30 試行でクリア率を測定。QA レポートを `docs/balance-reports/` に保存。
6. **最終確定**: KPI が目標に達したらステージ設定をロックし、バージョンタグへ反映。

## メトリクス基準値

<!-- 数値目標を明示し、調整結果の判断基準とする -->
- クリア率: 序盤 70%以上、中盤 55%以上、終盤 45%以上。
- 平均手数: 盤面サイズ × 5 ±10%。例: 5×5 なら 25±2.5 手。
- 平均ペナルティ: 序盤 1.0 以下、中盤 1.5 以下、終盤 2.0 以下。
- 平均プレイ時間: 序盤 90 秒以内、中盤 120 秒以内、終盤 150 秒以内。
- リトライ率: 30% を超える場合はセカンダリ条件または山札重みの緩和を検討。

## 調整履歴テンプレート

<!-- 変更履歴を残すテンプレートを用意し、誰が何を調整したか追跡できるようにする -->
```markdown
### 2024-04-10 調整メモ（担当: 山田）
- 対象: 3-2 斜め選択応用
- 目的: クリア率 48% → 55%
- 変更点:
  - 選択カードの重みを 0.8 → 0.85 に変更
  - セカンダリ条件「32 手以内」を「34 手以内」へ緩和
- 結果: テスト 30 試行でクリア率 56%、平均手数 26.8 手
```

<!-- 上記テンプレートは docs/balance-reports/ 配下の個別ファイルに追記する運用 -->

## QA チェックリスト（キャンペーン専用）

<!-- リリース前チェックリストからキャンペーン固有の観点を抜粋 -->
- [ ] 章ごとのギミック紹介がチュートリアルフローに組み込まれている。
- [ ] ステージセレクトでアンロック条件が正しく表示される（非解放時のツールチップ含む）。
- [ ] 二度踏み・トグル・障害物マスの挙動が最新仕様と一致している。
- [ ] 山札プリセットの重みが `DeckTests` の期待値を満たす。
- [ ] セカンダリ条件達成時に報酬演出が正しく発火する。
- [ ] スコア目標未達成時は星付与が減衰し、ランキング送信が抑止される設定になっている。

<!-- QA チェックリストはステージ追加ごとに更新し、未対応項目が残っていれば調整完了扱いにしない -->

## 章別詳細

### 第 1 章「基礎訓練」

<!-- 章のテーマと難度曲線を具体的に記述し、調整方針の共有を促す -->
- テーマ: 小サイズ盤での基礎操作習熟。
- 共有ペナルティ: クラシカル由来の設定（手詰まり +2 / 引き直し +2 / 捨て札 +1 / 再訪 +1）が 1-1 に適用される。1-2 では引き直し +1 / 捨て札 +1 / 再訪 0 へと緩和。

#### 1-1 王将訓練
- 盤面: 3×3、初期位置は中央固定。
- 山札: `GameDeckPreset.kingOnly`（王将カードのみ）。
- ペナルティ: 手詰まり +2、引き直し +2、捨て札 +1、再訪 +1。
- ギミック: なし。
- セカンダリ条件: 120 秒以内にクリア。
- スコア目標: 900 未満（厳密には「未満」条件）。
- アンロック条件: 初期解放（スター要件 0）。

#### 1-2 序盤応用
- 盤面: 4×4、初期位置は中央固定。
- 山札: `GameDeckPreset.standard`（スタンダード構成）。
- ペナルティ: 手詰まり +3、引き直し +1、捨て札 +1、再訪 0。
- ギミック: なし。
- セカンダリ条件: ペナルティ発生 5 回以下。
- スコア目標: 350 未満（厳密には「未満」条件）。
- アンロック条件: ステージ 1-1 のクリア。

### 第 2 章「応用特訓」

<!-- 二度踏みの学習意図と配置座標を具体的に残し、盤面再現時のミスを避ける -->
- テーマ: 複数回の踏破を要求するマス運用。
- 二度踏みマス: (1,2)・(3,4)（1 始まり座標、内部では (0,1)・(2,3)）。
- ペナルティ: 手詰まり +3、引き直し +1、捨て札 +1、再訪 0。

#### 2-1 重踏応用
- 盤面: 4×4、初期位置は中央固定。
- 山札: `GameDeckPreset.standard`（スタンダード構成）。
- ペナルティ: 章共通設定。
- ギミック: 上記 2 マスが踏破 2 回で完了する追加訪問要求を持つ。
- セカンダリ条件: ペナルティ発生 5 回以下。
- スコア目標: 350 未満（厳密には「未満」条件）。
- アンロック条件: ステージ 1-2 のクリア。

### 第 3 章「多方向訓練」

<!-- 選択カードの段階的解放を整理し、カード構成の誤設定を防ぐ -->
- テーマ: 選択式キング／桂馬カードの操作習得。
- ペナルティ: スタンダード基準（手詰まり +5、引き直し +5、捨て札 +1、再訪 0）。
- 共通設定: 5×5 盤・中央固定スポーン・手札 5 種・先読み 3 枚・スタック可。

#### 3-1 縦横選択訓練
- 山札: `GameDeckPreset.standardWithOrthogonalChoices`（縦横選択キングを追加）。
- ギミック: 追加なし。
- セカンダリ条件: ペナルティなしでクリア。
- スコア目標: 600 以下（「以下」条件）。
- アンロック条件: ステージ 2-1 のクリア。

#### 3-2 斜め選択応用
- 山札: `GameDeckPreset.standardWithDiagonalChoices`（斜め選択キングを追加）。
- ギミック: 追加なし。
- セカンダリ条件: 32 手以内にクリア。
- スコア目標: 580 以下（「以下」条件）。
- アンロック条件: ステージ 3-1 のクリア。

#### 3-3 桂馬選択攻略
- 山札: `GameDeckPreset.standardWithKnightChoices`（桂馬選択カードを追加）。
- ギミック: 追加なし。
- セカンダリ条件: 30 手以内にクリア。
- スコア目標: 560 以下（「以下」条件）。
- アンロック条件: ステージ 3-2 のクリア。

#### 3-4 総合選択演習
- 山札: `GameDeckPreset.standardWithAllChoices`（全選択カードを追加）。
- ギミック: 追加なし。
- セカンダリ条件: 28 手以内にクリア。
- スコア目標: 540 未満（厳密には「未満」条件）。
- アンロック条件: ステージ 3-3 のクリア。

### 第 4 章「反転応用」

<!-- トグルマスの座標と目的を明記し、盤面構築時の再現性を担保する -->
- テーマ: トグルマスによる踏破状態の反転管理。
- トグルマス: (1,2)・(3,4)（1 始まり、内部では (0,1)・(2,3)）。
- ペナルティ: スタンダード基準（手詰まり +5、引き直し +5、捨て札 +1、再訪 0）。

#### 4-1 反転制御訓練
- 盤面: 5×5、初期位置は中央固定。
- 山札: `GameDeckPreset.standard`（スタンダード構成）。
- ギミック: 上記トグルマスで踏破状態が踏むたびに反転。
- セカンダリ条件: 30 手以内にクリア。
- スコア目標: 520 以下（「以下」条件）。
- アンロック条件: ステージ 3-4 のクリア。

### 第 5 章「障害物攻略」

<!-- 障害物マスを指定し、経路検証時に参照できるよう記録する -->
- テーマ: 移動不可マスを避けるルート設計。
- 障害物マス: (1,2)・(3,4)（1 始まり、内部では (0,1)・(2,3)）。
- ペナルティ: スタンダード基準（手詰まり +5、引き直し +5、捨て札 +1、再訪 0）。

#### 5-1 障害物突破演習
- 盤面: 5×5、初期位置は中央固定。
- 山札: `GameDeckPreset.standardWithAllChoices`（全選択カードを追加）。
- ギミック: 上記 2 マスが完全な障害物として機能。
- セカンダリ条件: 27 手以内にクリア。
- スコア目標: 500 未満（厳密には「未満」条件）。
- アンロック条件: ステージ 4-1 のクリア。
